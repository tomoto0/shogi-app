function e(e,o,t=!1){return{type:e,owner:o,isPromoted:t}}function o(){const o=Array(9).fill(null).map(()=>Array(9).fill(null));o[0][0]=e("lance","gote"),o[0][1]=e("knight","gote"),o[0][2]=e("silver","gote"),o[0][3]=e("gold","gote"),o[0][4]=e("king","gote"),o[0][5]=e("gold","gote"),o[0][6]=e("silver","gote"),o[0][7]=e("knight","gote"),o[0][8]=e("lance","gote"),o[1][1]=e("rook","gote"),o[1][7]=e("bishop","gote");for(let t=0;t<9;t++)o[2][t]=e("pawn","gote");for(let t=0;t<9;t++)o[6][t]=e("pawn","sente");return o[7][1]=e("bishop","sente"),o[7][7]=e("rook","sente"),o[8][0]=e("lance","sente"),o[8][1]=e("knight","sente"),o[8][2]=e("silver","sente"),o[8][3]=e("gold","sente"),o[8][4]=e("king","sente"),o[8][5]=e("gold","sente"),o[8][6]=e("silver","sente"),o[8][7]=e("knight","sente"),o[8][8]=e("lance","sente"),o}function t(){return{board:o(),hands:{sente:{rook:0,bishop:0,gold:0,silver:0,knight:0,lance:0,pawn:0},gote:{rook:0,bishop:0,gold:0,silver:0,knight:0,lance:0,pawn:0}},currentPlayer:"sente",moveHistory:[],positionHistory:[],moveCount:0,gamePhase:"opening",result:{type:"ongoing"},isCheck:!1}}function n(e){return{rowIndex:e.row-1,colIndex:9-e.col}}function r(e,o){return{col:9-o,row:e+1}}function i(e,o){const{rowIndex:t,colIndex:r}=n(o);return e[t][r]}function c(e,o){return e>=1&&e<=9&&o>=1&&o<=9}function s(e,o){return{...e,[o]:e[o]+1}}function p(e,o){if(e[o]<=0)throw new Error(`Cannot remove ${o} from hand: none available`);return{...e,[o]:e[o]-1}}const u={rook:"promotedRook",bishop:"promotedBishop",silver:"promotedSilver",knight:"promotedKnight",lance:"promotedLance",pawn:"promotedPawn"},l={promotedRook:"rook",promotedBishop:"bishop",promotedSilver:"silver",promotedKnight:"knight",promotedLance:"lance",promotedPawn:"pawn"};function a(e){return e in u}function d(e){const o=u[e];if(!o)throw new Error(`Cannot promote ${e}`);return o}function f(e){return e in l}function m(e){const o=function(e){return f(e)?l[e]:e}(e);if("king"===o)throw new Error("King cannot be captured");return o}function h(e){return e.map(e=>e.map(e=>e?{...e}:null))}const y={UP:{col:0,row:-1},DOWN:{col:0,row:1},LEFT:{col:-1,row:0},RIGHT:{col:1,row:0},UP_LEFT:{col:-1,row:-1},UP_RIGHT:{col:1,row:-1},DOWN_LEFT:{col:-1,row:1},DOWN_RIGHT:{col:1,row:1},KNIGHT_LEFT:{col:-1,row:-2},KNIGHT_RIGHT:{col:1,row:-2}},g=[{direction:y.UP,type:"step"},{direction:y.DOWN,type:"step"},{direction:y.LEFT,type:"step"},{direction:y.RIGHT,type:"step"},{direction:y.UP_LEFT,type:"step"},{direction:y.UP_RIGHT,type:"step"},{direction:y.DOWN_LEFT,type:"step"},{direction:y.DOWN_RIGHT,type:"step"}],w=[{direction:y.UP,type:"slide"},{direction:y.DOWN,type:"slide"},{direction:y.LEFT,type:"slide"},{direction:y.RIGHT,type:"slide"}],v=[...w,{direction:y.UP_LEFT,type:"step"},{direction:y.UP_RIGHT,type:"step"},{direction:y.DOWN_LEFT,type:"step"},{direction:y.DOWN_RIGHT,type:"step"}],k=[{direction:y.UP_LEFT,type:"slide"},{direction:y.UP_RIGHT,type:"slide"},{direction:y.DOWN_LEFT,type:"slide"},{direction:y.DOWN_RIGHT,type:"slide"}],P=[...k,{direction:y.UP,type:"step"},{direction:y.DOWN,type:"step"},{direction:y.LEFT,type:"step"},{direction:y.RIGHT,type:"step"}],T=[{direction:y.UP,type:"step"},{direction:y.UP_LEFT,type:"step"},{direction:y.UP_RIGHT,type:"step"},{direction:y.LEFT,type:"step"},{direction:y.RIGHT,type:"step"},{direction:y.DOWN,type:"step"}],b={king:g,rook:w,bishop:k,gold:T,silver:[{direction:y.UP,type:"step"},{direction:y.UP_LEFT,type:"step"},{direction:y.UP_RIGHT,type:"step"},{direction:y.DOWN_LEFT,type:"step"},{direction:y.DOWN_RIGHT,type:"step"}],knight:[{direction:y.KNIGHT_LEFT,type:"step"},{direction:y.KNIGHT_RIGHT,type:"step"}],lance:[{direction:y.UP,type:"slide"}],pawn:[{direction:y.UP,type:"step"}],promotedRook:v,promotedBishop:P,promotedSilver:T,promotedKnight:T,promotedLance:T,promotedPawn:T};function I(e,o){return"gote"===o?{col:-e.col,row:-e.row}:e}function H(e,o,t,n){const r=[],s=b[t];for(const p of s){const t=I(p.direction,n);if("step"===p.type){const s=o.col+t.col,p=o.row+t.row;if(c(s,p)){const o={col:s,row:p},t=i(e,o);t&&t.owner===n||r.push(o)}}else{let s=o.col+t.col,p=o.row+t.row;for(;c(s,p);){const o={col:s,row:p},c=i(e,o);if(c){if(c.owner!==n){r.push(o);break}break}r.push(o),s+=t.col,p+=t.row}}}return r}function _(e,o,t){if("sente"===t){if("pawn"===e||"lance"===e)return 1===o.row;if("knight"===e)return o.row<=2}else{if("pawn"===e||"lance"===e)return 9===o.row;if("knight"===e)return o.row>=8}return!1}function G(e,o,t){return"sente"===t?e.row<=3||o.row<=3:e.row>=7||o.row>=7}function L(e,o,t){return _(e,o,t)}function R(e,o){const t=function(e,o){for(let t=0;t<9;t++)for(let n=0;n<9;n++){const i=e[t][n];if(i&&"king"===i.type&&i.owner===o)return r(t,n)}return null}(e,o);if(!t)return!1;return function(e,o,t){for(let n=0;n<9;n++)for(let i=0;i<9;i++){const c=e[n][i];if(c&&c.owner===t&&H(e,r(n,i),c.type,t).some(e=>e.col===o.col&&e.row===o.row))return!0}return!1}(e,t,"sente"===o?"gote":"sente")}function E(e,o){const t=h(e),{rowIndex:r,colIndex:i}=n(o.from),{rowIndex:c,colIndex:s}=n(o.to),p=t[r][i],u=t[c][s];return t[r][i]=null,p&&(o.promote&&a(p.type)&&!f(p.type)?t[c][s]={...p,type:d(p.type),isPromoted:!0}:t[c][s]=p),{newBoard:t,captured:u}}function N(e,o,t){const r=h(e),{rowIndex:i,colIndex:c}=n(o.to);return r[i][c]={type:o.piece,owner:t,isPromoted:!1},r}function U(e,o,t){const{newBoard:n}=E(e,o);return!R(n,t)}function $(e,o,t,r){if(r[o.piece]<=0)return!1;if(i(e,o.to))return!1;if(_(o.piece,o.to,t))return!1;if("pawn"===o.piece){const{colIndex:r}=n(o.to);for(let o=0;o<9;o++){const n=e[o][r];if(n&&"pawn"===n.type&&n.owner===t&&!n.isPromoted)return!1}}if("pawn"===o.piece){if(M(N(e,o,t),"sente"===t?"gote":"sente"))return!1}return!R(N(e,o,t),t)}function F(e,o,t){const n=i(e,o);if(!n||n.owner!==t)return[];const r=H(e,o,n.type,t),c=[];for(const s of r){const r=i(e,s),p=r?.type,u=a(n.type)&&!f(n.type)&&G(o,s,t),l=L(n.type,s,t);if(u){const r={type:"move",from:o,to:s,piece:n.type,captured:p,promote:!0};if(U(e,r,t)&&c.push(r),!l){const r={type:"move",from:o,to:s,piece:n.type,captured:p,promote:!1};U(e,r,t)&&c.push(r)}}else{const r={type:"move",from:o,to:s,piece:n.type,captured:p,promote:!1};U(e,r,t)&&c.push(r)}}return c}function O(e){const{board:o,hands:t,currentPlayer:n}=e,i=[];for(let s=0;s<9;s++)for(let e=0;e<9;e++){const t=o[s][e];if(t&&t.owner===n){const t=F(o,r(s,e),n);i.push(...t)}}const c=function(e,o,t){const n=[],r=["rook","bishop","gold","silver","knight","lance","pawn"];for(const i of r)if(!(t[i]<=0))for(let r=1;r<=9;r++)for(let c=1;c<=9;c++){const s={type:"drop",to:{col:c,row:r},piece:i};$(e,s,o,t)&&n.push(s)}return n}(o,n,t[n]);return i.push(...c),i}function M(e,o,t){if(!R(e,o))return!1;for(let n=0;n<9;n++)for(let t=0;t<9;t++){const i=e[n][t];if(i&&i.owner===o){const c=r(n,t),s=H(e,c,i.type,o);for(const t of s){if(U(e,{from:c,to:t,piece:i.type,promote:!1},o))return!1;if(a(i.type)&&!f(i.type)){if(U(e,{from:c,to:t,piece:i.type,promote:!0},o))return!1}}}}if(t){const n=["rook","bishop","gold","silver","knight","lance","pawn"];for(const r of n)if(!(t[r]<=0))for(let n=1;n<=9;n++)for(let i=1;i<=9;i++){if(x(e,{to:{col:i,row:n},piece:r},o,t))return!1}}return!0}function x(e,o,t,r){if(r[o.piece]<=0)return!1;if(i(e,o.to))return!1;if(_(o.piece,o.to,t))return!1;if("pawn"===o.piece){const{colIndex:r}=n(o.to);for(let o=0;o<9;o++){const n=e[o][r];if(n&&"pawn"===n.type&&n.owner===t&&!n.isPromoted)return!1}}return!R(N(e,o,t),t)}function D(e){const{board:o,currentPlayer:t}=e;if(R(o,t))return!1;return 0===O(e).length}function W(e,o,t){const n=F(e,o,t),r=new Map;for(const i of n){const e=`${i.to.col}-${i.to.row}`;r.has(e)||r.set(e,i.to)}return Array.from(r.values())}let S={openingName:null,currentPlan:"",longTermGoals:[],recentMoves:[],threatHistory:[]};function K(){S={openingName:null,currentPlan:"",longTermGoals:[],recentMoves:[],threatHistory:[]}}const B={king:0,rook:1e3,bishop:900,gold:500,silver:450,knight:350,lance:300,pawn:100,promotedRook:1300,promotedBishop:1200,promotedSilver:500,promotedKnight:500,promotedLance:500,promotedPawn:600};const C={king:0,rook:1e3,bishop:900,gold:500,silver:450,knight:350,lance:300,pawn:100,promotedRook:1300,promotedBishop:1200,promotedSilver:500,promotedKnight:500,promotedLance:500,promotedPawn:600},j={rook:1200,bishop:1100,gold:550,silver:500,knight:350,lance:300,pawn:120};function A(e,o){const t=Math.abs(e-4),n=Math.abs(o-4);return Math.max(0,20-3*(t+n))}function q(e,o){let t=0,n=-1,r=-1;for(let i=0;i<9;i++){for(let t=0;t<9;t++){const c=e[i][t];if(c&&"king"===c.type&&c.owner===o){n=i,r=t;break}}if(n>=0)break}if(n<0)return-1e4;t+="sente"===o?n>=6?50:n>=4?0:-30:n<=2?50:n<=4?0:-30;for(let i=-1;i<=1;i++)for(let c=-1;c<=1;c++){if(0===i&&0===c)continue;const s=n+i,p=r+c;if(s>=0&&s<9&&p>=0&&p<9){const n=e[s][p];n&&n.owner===o&&(t+=10)}}return t}function z(e){const{board:o,hands:t}=e;let n=0;for(let r=0;r<9;r++)for(let e=0;e<9;e++){const t=o[r][e];if(!t)continue;const i=C[t.type],c="sente"===t.owner?1:-1;n+=i*c,"king"!==t.type&&(n+=A(e,r)*c*.3)}for(const[r,i]of Object.entries(t.sente))i>0&&r in j&&(n+=j[r]*i);for(const[r,i]of Object.entries(t.gote))i>0&&r in j&&(n-=j[r]*i);return n+=q(o,"sente"),n-=q(o,"gote"),R(o,"sente")&&(n-=150),R(o,"gote")&&(n+=150),n}function J(e,o){const{board:t,hands:n,currentPlayer:r}=e,i="sente"===r?"gote":"sente";if("move"===o.type){const{newBoard:c,captured:p}=E(t,o);let u={...n};if(p){const e=m(p.type);u={...u,[r]:s(u[r],e)}}return{...e,board:c,hands:u,currentPlayer:i,moveCount:e.moveCount+1}}{const c=N(t,o,r),s={...n,[r]:p(n[r],o.piece)};return{...e,board:c,hands:s,currentPlayer:i,moveCount:e.moveCount+1}}}function Q(e,o,t,n,r,i){if(i.count++,0===o)return{score:z(e),move:null,nodesSearched:i.count};const c=O(e);if(0===c.length){return R(e.board,e.currentPlayer)?{score:r?1e3*(3-o)-1e5:1e5-1e3*(3-o),move:null,nodesSearched:i.count}:{score:0,move:null,nodesSearched:i.count}}const s=c.sort((e,o)=>{const t="move"===e.type&&e.captured?C[e.captured]:0;return("move"===o.type&&o.captured?C[o.captured]:0)-t});let p=null;if(r){let r=-1/0;for(const c of s){const s=Q(J(e,c),o-1,t,n,!1,i);if(s.score>r&&(r=s.score,p=c),n<=(t=Math.max(t,s.score)))break}return{score:r,move:p,nodesSearched:i.count}}{let r=1/0;for(const c of s){const s=Q(J(e,c),o-1,t,n,!0,i);if(s.score<r&&(r=s.score,p=c),(n=Math.min(n,s.score))<=t)break}return{score:r,move:p,nodesSearched:i.count}}}async function V(e,o){switch(o){case"beginner":const o=function(e){const o=O(e);if(0===o.length)return null;const t=o.filter(e=>"move"===e.type&&e.captured);if(t.length>0){t.sort((e,o)=>{if("move"!==e.type||"move"!==o.type)return 0;const t=e.captured?B[e.captured]:0;return(o.captured?B[o.captured]:0)-t});const e="move"===t[0].type&&t[0].captured?B[t[0].captured]:0,o=t.filter(o=>!("move"!==o.type||!o.captured)&&B[o.captured]>=.8*e);if(Math.random()<.8&&o.length>0)return o[Math.floor(Math.random()*o.length)]}const n=o.map(e=>({move:e,score:100*Math.random()}));return n.sort((e,o)=>o.score-e.score),n[0].move}(e);return o?{move:o,thinking:["駒得を狙いつつ、ランダムに選択"],evaluation:0}:null;case"intermediate":return async function(e){const o=[],t=O(e);if(0===t.length)return o.push("合法手がありません。"),null;o.push(`${t.length}手の候補を検討中...`),o.push("2手先まで読みます...");const n={count:0},r=Q(e,2,-1/0,1/0,"sente"===e.currentPlayer,n);if(!r.move)return{move:t[Math.floor(Math.random()*t.length)],thinking:[...o,"ランダムに選択"],evaluation:z(e)};if(o.push(`${n.count}局面を評価しました`),o.push(`評価値: ${r.score>0?"+":""}${r.score}`),"move"===r.move.type){const e=`${r.move.from.col}${r.move.from.row}`,t=`${r.move.to.col}${r.move.to.row}`,n=r.move.captured?"（駒を取る）":"";o.push(`${e} → ${t}${n} を選択`)}else o.push(`${r.move.piece}を打つ`);return{move:r.move,thinking:o,evaluation:r.score,nodesSearched:n.count}}(e);case"advanced":case"llm":return async function(e){const o=[],t=O(e);if(0===t.length)return null;o.push(`${t.length}手の候補を検討中...`),o.push("3手先まで読みます...");const n={count:0},r=Q(e,3,-1/0,1/0,"sente"===e.currentPlayer,n);if(!r.move)return{move:t[Math.floor(Math.random()*t.length)],thinking:[...o,"ランダムに選択"],evaluation:z(e)};return o.push(`${n.count}局面を評価しました`),o.push(`評価値: ${r.score>0?"+":""}${r.score}`),{move:r.move,thinking:o,evaluation:r.score,nodesSearched:n.count}}(e);default:return null}}export{D as a,R as b,t as c,W as d,$ as e,E as f,i as g,s as h,M as i,a as j,f as k,G as l,L as m,N as n,p as o,d as p,V as q,K as r,m as t};
